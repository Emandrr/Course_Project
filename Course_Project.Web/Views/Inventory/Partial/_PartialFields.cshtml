<div class="content">
	<h3 class="elements-title">@Localizer["Custom elements"]</h3>
<div class="elements-sidebar">
		<form method="post" asp-controller="inventory" asp-action="UpdateElems" enctype="multipart/form-data" id="customElemsForm">
			<input type="hidden" name="Version" value="@Model.inventory.Version" />
	<div id="customElemsContainer">
		@for (int i = 0; i < ViewData.Model.inventory.CustomElems.Count; i++)
		{
			<div class="custom-elem-group" data-id="@i" draggable="true">
				<input type="hidden" name="CustomElems.Index" value="@i" />
				<div class="form-group">
					<label>@Localizer["Element name"]</label>
					<input name="CustomElems[@i].Name" class="form-control" value="@ViewData.Model.inventory.CustomElems[i].Name" />
				</div>
				<div class="form-group">
					<label>@Localizer["Description"]</label>
					<input name="CustomElems[@i].Description" class="form-control" />
				</div>
				<div class="form-group">
                            <label>@Localizer["Element type"]</label>
                            <div class="form-control" readonly>
								@{
									var fieldType = ViewData.Model.inventory.CustomElems[i].FieldType.ToString();
									string displayText = fieldType switch
									{
										"SingleLine" => Localizer["Single line text"].Value,
										"MultiLine" => Localizer["Multiline text"].Value,
										"Numeric" => Localizer["Number"].Value,
										"Checkbox" => Localizer["Boolean"].Value,
										"Link" => Localizer["Link"].Value,
										_ => fieldType
									};
								}
								@displayText
                            </div>
                </div>
				<div class="checkbox-group">
					<input type="checkbox" id="isVisible_@i" name="CustomElems[@i].IsVisible" checked="@ViewData.Model.inventory.CustomElems[i].IsVisible" />
					<label for="isVisible_@i">@Localizer["Visible"]</label>
				</div>
			</div>
		}
	</div>
	</form>
</div>
<button type="button" id="addElemsBtn" class="btn btn-primary">@Localizer["Add element"]</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
	$(document).ready(function () {
		let elemIndex = @ViewData.Model.inventory.CustomElems.Count;
		let hasChanges = false;
		let saveTimer = null;
		const savedBadge = $('#savedBadge');
		function updateSaveStatus(status) {
			savedBadge.removeClass('saved unsaved saving');
			switch(status) {
				case 'saved':
					savedBadge.addClass('saved').text('All changes saved');
					break;
				case 'unsaved':
					savedBadge.addClass('unsaved').text('Not saved');
					break;
			}
		}
		function saveForm() {
			if (!hasChanges) return;

			updateSaveStatus('saving');

			const formData = new FormData($('#customElemsForm')[0]);
			formData.append('inventoryId', '@Model.inventory.PublicId');
			formData.append('Version','@Model.inventory.Version');
			$.ajax({
				url: '/Inventory/UpdateElems',
				type: 'POST',
				data: formData,
				processData: false,
				contentType: false,
				success: function(response) {
					updateSaveStatus('saved');
					hasChanges = false;
				},
				error: function(response){
					updateSaveStatus('unsaved');
				}
			});
		}
		function startSaveTimer() {
			if (saveTimer) {
				clearTimeout(saveTimer);
			}
			saveTimer = setTimeout(saveForm, 5000);
		}
		$('#customElemsForm').on('input change', 'input, select', function() {
			hasChanges = true;
			updateSaveStatus('unsaved');
			startSaveTimer();
		});
		const localizerElems = {
			elementName: "@Localizer["Element name"]",
			description: "@Localizer["Description"]",
			elementType: "@Localizer["Element type"]",
			singleLine: "@Localizer["Single line text"]",
			multiLine: "@Localizer["Multiline text"]",
			numeric: "@Localizer["Number"]",
			checkbox: "@Localizer["Boolean"]",
			link: "@Localizer["Link"]",
			visible: "@Localizer["Visible"]"
		};

		$('#addElemsBtn').click(function () {
			const newElemHtml = `
				<div class="custom-elem-group" data-id="${elemIndex}" draggable="true">
					<input type="hidden" name="CustomElems.Index" value="${elemIndex}" />
					<div class="form-group">
						<label>${localizerElems.elementName}</label>
						<input name="CustomElems[${elemIndex}].Name" class="form-control" />
					</div>
					<div class="form-group">
						<label>${localizerElems.description}</label>
						<input name="CustomElems[${elemIndex}].Description" class="form-control" />
					</div>
					<div class="form-group">
						<label>${localizerElems.elementType}</label>
						<select name="CustomElems[${elemIndex}].FieldType" class="form-control">
							<option value="SingleLine">${localizerElems.singleLine}</option>
							<option value="MultiLine">${localizerElems.multiLine}</option>
							<option value="Numeric">${localizerElems.numeric}</option>
							<option value="Checkbox">${localizerElems.checkbox}</option>
							<option value="Link">${localizerElems.link}</option>
						</select>
					</div>
					<div class="checkbox-group">
						<input type="checkbox" id="isVisible_${elemIndex}" name="CustomElems[${elemIndex}].IsVisible" />
						<label for="isVisible_${elemIndex}">${localizerElems.visible}</label>
					</div>
				</div>
			`;

			$('#customElemsContainer').append(newElemHtml);
			elemIndex++;
			hasChanges = true;
			updateSaveStatus('unsaved');
			startSaveTimer();

			initDraggable();
		});

		const container = document.getElementById("customElemsContainer");
		let dragged = null;

		function initDraggable() {
			Array.from(container.querySelectorAll(".custom-elem-group")).forEach(el => {
				el.setAttribute("draggable", "true");
			});
		}
		initDraggable();
		container.addEventListener("dragstart", e => {
			if (e.target.classList.contains("custom-elem-group")) {
				dragged = e.target;
				e.dataTransfer.effectAllowed = "move";
			}
		});
		container.addEventListener("dragover", e => {
			e.preventDefault();
			const target = e.target.closest(".custom-elem-group");
			if (target && target !== dragged) {
				const rect = target.getBoundingClientRect();
				const next = (e.clientY - rect.top) / (rect.height) > 0.5;
				container.insertBefore(dragged, next ? target.nextSibling : target);
			}
		});
		container.addEventListener("drop", e => {
			e.preventDefault();
			if (dragged) {
				hasChanges = true;
				updateSaveStatus('unsaved');
				startSaveTimer();
			}
			dragged = null;
		});
		document.addEventListener("drop", e => {
			if (dragged && !container.contains(e.target)) {
				dragged.remove();
				hasChanges = true;
				updateSaveStatus('unsaved');
				startSaveTimer();
			}
			dragged = null;
		});
		document.addEventListener("dragover", e => {
			e.preventDefault();
		});
		$(window).on('beforeunload', function() {
			if (hasChanges) {
				saveForm();
				return 'You have unsaved changes. Are you sure you want to leave?';
			}
		});
	});
</script>