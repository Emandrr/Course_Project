@model Course_Project.Web.ViewModels.InventoryCreateViewModel;
<link rel="stylesheet" href="~/css/inventory.css" />

	<h1 class="inventory-title">@Localizer["Create new inventory"]</h1>

	<form method="post" asp-controller="Inventory" asp-action="Create" enctype="multipart/form-data">
		<div class="content-container">
			<div class="main-form">
				<div class="form-group">
					<label for="Title">@Localizer["Title"]</label>
					<input name="Title" id="Title" type="text" autocomplete="on" placeholder="@Localizer["Enter title"]" />
					<span class="text-danger field-validation-valid" data-valmsg-for="inventory.Title" data-valmsg-replace="true"></span>
				</div>

				<div class="form-group">
					<label for="Description">@Localizer["Description"]</label>
					<input name="Description" id="Description" type="text" autocomplete="on" placeholder="@Localizer["Enter description"]" />
					<div class="validation-message"></div>
				</div>

				<div class="form-group form-check">
					<input asp-for="IsPublic" class="form-check-input" />
					<label asp-for="IsPublic" class="form-check-label">@Localizer["Public"]</label>
					<span asp-validation-for="IsPublic" class="text-danger"></span>
				</div>

				<div class="form-group">
					<label for="ImageFile">@Localizer["Choose photo"]</label>
					<input name="ImageFile" id="ImageFile" type="file" class="form-control-file" accept="image/*">
					<span class="text-danger"></span>
				</div>

				<div id="imagePreview" class="mt-3"></div>

				<input type="hidden" name="UserId" value="@Model.UserId" />

				<div class="form-group">
					<label asp-for="SelectedCategoryId" class="control-label">@Localizer["Select category"]</label>
					<select asp-for="SelectedCategoryId" asp-items="@(new SelectList(Model.Categories, "Id", "Name"))" class="form-control">
					</select>
					<span asp-validation-for="SelectedCategoryId" class="text-danger"></span>
				</div>
			</div>
			<div class="form-group">
				<label for="tagInput">@Localizer["Tags"]</label>
				<input type="text" id="tagInput" placeholder="@Localizer["Input tag"]" class="form-control" />
				<div id="suggestions" class="suggestions"></div>
				<div id="selectedTags" class="selected-tags"></div>
				<input type="hidden" name="Tags" id="hiddenTags" />
			</div>
		<div class="form-buttons">
			<button type="submit" class="btn btn-scnd">@Localizer["Create new inventory"]</button>
			<button type="button" id="addElemBtn" class="btn btn-secondary">@Localizer["Add element"]</button>
		</div>
			<div class="elements-sidebar">
				<h3 class="elements-title">@Localizer["Custom elements"]</h3>
				<div id="customElemsContainer">
				</div>
			</div>
		</div>
	</form>
<script>
		function getLocalizedText(key) {
		const translations = {
			'ElementName': '@Localizer["Element name"]',
			'Description': '@Localizer["Description"]',
			'ElementType': '@Localizer["Element type"]',
			'SingleLineText': '@Localizer["Single line text"]',
			'MultilineText': '@Localizer["Multi line text"]',
			'Number': '@Localizer["Number"]',
			'Boolean': '@Localizer["Boolean"]',
			'Link': '@Localizer["Link"]',
			'Visible': '@Localizer["Visible"]'
		};
		return translations[key] || key;
	}
	$(document).ready(function () {
		let elemIndex = @Model.CustomElems.Count;
		$('#addElemBtn').click(function () {
		const newElemHtml = `
		<div class="custom-elem-group" data-id="${elemIndex}" draggable="true">
			<input type="hidden" name="CustomElems.Index" value="${elemIndex}" />
			<div class="form-group">
				<label>${getLocalizedText('ElementName')}</label>
				<input name="CustomElems[${elemIndex}].Name" class="form-control" />
			</div>
			<div class="form-group">
				<label>${getLocalizedText('Description')}</label>
				<input name="CustomElems[${elemIndex}].Description" class="form-control" />
			</div>
			<div class="form-group">
				<label>${getLocalizedText('ElementType')}</label>
				<select name="CustomElems[${elemIndex}].FieldType" class="form-control">
					<option value="SingleLine">${getLocalizedText('SingleLineText')}</option>
					<option value="MultiLine">${getLocalizedText('MultilineText')}</option>
					<option value="Numeric">${getLocalizedText('Number')}</option>
					<option value="Checkbox">${getLocalizedText('Boolean')}</option>
					<option value="Link">${getLocalizedText('Link')}</option>
				</select>
			</div>
			<div class="checkbox-group">
				<input type="checkbox" id="isVisible_${elemIndex}" name="CustomElems[${elemIndex}].IsVisible" />
				<label for="isVisible_${elemIndex}">${getLocalizedText('Visible')}</label>
			</div>
		</div>
		`;
			$('#customElemsContainer').append(newElemHtml);
			elemIndex++;

			initDraggable();
		});

		const container = document.getElementById("customElemsContainer");
		let dragged = null;

		function initDraggable() {
			Array.from(container.querySelectorAll(".custom-elem-group")).forEach(el => {
				el.setAttribute("draggable", "true");
			});
		}
		initDraggable();

		container.addEventListener("dragstart", e => {
			if (e.target.classList.contains("custom-elem-group")) {
				dragged = e.target;
				e.dataTransfer.effectAllowed = "move";
			}
		});

		container.addEventListener("dragover", e => {
			e.preventDefault();
			const target = e.target.closest(".custom-elem-group");
			if (target && target !== dragged) {
				const rect = target.getBoundingClientRect();
				const next = (e.clientY - rect.top) / (rect.height) > 0.5;
				container.insertBefore(dragged, next ? target.nextSibling : target);
			}
		});

		container.addEventListener("drop", e => {
			e.preventDefault();
			dragged = null;
		});

		document.addEventListener("drop", e => {
			if (dragged && !container.contains(e.target)) {
				dragged.remove();
			}
			dragged = null;
		});

		document.addEventListener("dragover", e => {
			e.preventDefault();
		});
		document.getElementById('ImageFile').addEventListener('change', function (e) {
			const file = e.target.files[0];
			if (file) {
				const previewContainer = document.getElementById('imagePreview');
				previewContainer.innerHTML = '';

				const img = document.createElement('img');
				img.src = URL.createObjectURL(file);
				img.classList.add('img-thumbnail');
				img.style.maxHeight = '200px';

				previewContainer.appendChild(img);
			}
		});
	});
</script>
<script>
	const allTags = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.AllTags));

	const input = document.getElementById("tagInput");
	const suggestions = document.getElementById("suggestions");
	const selectedTags = document.getElementById("selectedTags");
	const hiddenTags = document.getElementById("hiddenTags");

	let chosen = [];

	input.addEventListener("input", () => {
		const query = input.value.trim().toLowerCase();
		suggestions.innerHTML = "";

		if (!query) return;

		const matches = allTags.filter(t =>
			t.toLowerCase().includes(query) && 
			!chosen.includes(t)
		);

		matches.forEach(tag => {
			const div = document.createElement("div");
			div.textContent = tag;
			div.classList.add("suggestion");
			div.addEventListener("click", () => {
				addTag(tag);
				input.value = "";
				suggestions.innerHTML = "";
			});
			suggestions.appendChild(div);
		});
	});


	input.addEventListener("keydown", (e) => {
		if (e.key === "Enter") {
			e.preventDefault();
			const text = input.value.trim();
			if (text && !chosen.includes(text)) {
				addTag(text);
				input.value = "";
				suggestions.innerHTML = "";
			}
		}
	});

	function addTag(name) {
		if (chosen.includes(name)) return;

		chosen.push(name);

		const span = document.createElement("span");
		span.textContent = name;
		span.classList.add("tag");
		span.setAttribute("draggable", "true");

		selectedTags.appendChild(span);
		syncHidden();

		span.addEventListener("dragstart", (e) => {
			span.classList.add("dragging");
			e.dataTransfer.effectAllowed = "move";
		});

		span.addEventListener("dragend", () => {
			span.classList.remove("dragging");
			syncHidden();
		});
	}
		document.addEventListener("drop", (e) => {
		const dragging = document.querySelector(".tag.dragging");
		if (dragging && !selectedTags.contains(e.target)) {
			const name = dragging.textContent;
			dragging.remove();
			chosen = chosen.filter(t => t !== name);
			syncHidden();
		}
	});
	function syncHidden() {
		hiddenTags.value = JSON.stringify(chosen);
	}
</script>

